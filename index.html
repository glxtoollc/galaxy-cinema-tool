<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="C√¥ng c·ª• t·∫°o l·ªãch chi·∫øu phim Galaxy Cinema - T·∫°o, ch·ªânh s·ª≠a v√† xu·∫•t l·ªãch chi·∫øu phim chuy√™n nghi·ªáp">
    <meta name="keywords" content="Galaxy Cinema, l·ªãch chi·∫øu phim, qu·∫£n l√Ω r·∫°p chi·∫øu phim">
    <meta name="author" content="Galaxy Cinema Tool">
    <title>Galaxy Cinema - C√¥ng c·ª• t·∫°o l·ªãch chi·∫øu</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            min-height: 140px;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header-tools {
            position: absolute;
            bottom: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-box {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            width: 200px;
        }
        .search-box:focus {
            outline: 2px solid white;
        }
        .header-movie-count {
            background: white;
            color: #1f2937;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .menu-wrapper {
            position: relative;
        }
        .menu-btn {
            background: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .menu-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 45px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 180px;
            z-index: 9999;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            color: #1f2937;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }
        .dropdown-item:hover {
            background: #f3f4f6;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background: #10b981;
        }
        .toast.error {
            background: #ef4444;
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
        }
        .left-panel {
            background: #f8f9fa;
            padding: 25px;
            border-right: 2px solid #dee2e6;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .right-panel {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .calendar-icon {
            cursor: pointer;
            font-size: 18px;
            margin-left: 8px;
            transition: transform 0.2s;
            display: inline-block;
        }
        .calendar-icon:hover {
            transform: scale(1.2);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        .custom-date-picker {
            display: flex;
            gap: 8px;
        }
        .date-labels {
            display: flex;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }
        .date-labels span:nth-child(1) {
            flex: 0 0 70px;
            text-align: center;
        }
        .date-labels span:nth-child(2) {
            flex: 1;
            text-align: center;
        }
        .date-labels span:nth-child(3) {
            flex: 0 0 85px;
            text-align: center;
        }
        .custom-date-picker select {
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .custom-date-picker select:nth-child(1) {
            flex: 0 0 70px;
        }
        .custom-date-picker select:nth-child(2) {
            flex: 1;
        }
        .custom-date-picker select:nth-child(3) {
            flex: 0 0 85px;
        }
        .custom-date-picker select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .time-picker {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .time-picker select {
            /* Removed flex: 1 to allow fixed width */
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-block {
            width: 100%;
        }
        .btn-info {
            background: #8b5cf6;
            color: white;
        }
        .btn-info:hover {
            background: #7c3aed;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .showtimes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .showtime-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        .movies-list {
            display: grid;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        .movies-list.cinema-vinh {
            background: #1e3c8a;
            border: 2px solid #1e40af;
        }
        .movies-list.cinema-vincom {
            background: #c96b2a;
            border: 2px solid #ea580c;
        }
        .movie-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        .movie-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        .movie-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .movie-card.highlight {
            border-color: #ea580c;
            background: #fed7aa;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.5);
        }
        .movie-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        .order-input {
            width: 45px;
            padding: 4px 8px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            color: #1f2937;
            transition: all 0.2s;
        }
        .order-input:hover {
            border-color: #3b82f6;
        }
        .order-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: #eff6ff;
        }
        /* Hide spinner arrows */
        .order-input::-webkit-inner-spin-button,
        .order-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .order-input[type=number] {
            -moz-appearance: textfield;
        }
        .movie-card h3 {
            color: #1f2937;
            font-size: 18px;
            cursor: pointer;
        }
        .movie-info {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #6b7280;
        }
        .age-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .age-P { background: #10b981; color: white; }
        .age-K { background: #f59e0b; color: white; }
        .age-T13 { background: #ef4444; color: white; }
        .age-T16 { background: #dc2626; color: white; }
        .age-T18 { background: #991b1b; color: white; }
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        .preview-section h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        .canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        #scheduleCanvas {
            max-width: 100%;
            max-height: 500px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            object-fit: contain;
        }
        #scheduleCanvas:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        .poster-preview {
            width: 100px;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
            border: 2px solid #e5e7eb;
        }
        .format-section {
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            background: white;
        }
        .format-section h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }
        .import-export-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .import-export-section .btn {
            flex: 1;
        }
        .footer {
            text-align: center;
            padding: 12px 15px;
            background: #f8f9fa;
            color: #6b7280;
            font-size: 11px;
            border-top: 1px solid #dee2e6;
            line-height: 1.6;
        }
        .footer-shortcuts {
            margin-bottom: 8px;
            padding: 6px 10px;
            background: #e5e7eb;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
        }
        .footer-shortcuts strong {
            color: #1f2937;
        }
        input[type="file"].hidden-input {
            display: none;
        }
        .save-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #10b981;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            font-size: 18px;
            font-weight: 600;
            animation: scaleIn 0.3s ease;
        }
        .save-notification.show {
            display: flex;
        }
        @keyframes scaleIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes scaleOut {
            from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            to { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
        .save-notification.hiding {
            animation: scaleOut 0.3s ease;
        }
        /* Search box styles - REMOVED, now in header */

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Image preview modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }
        .image-modal.show {
            display: block;
        }
        .image-modal-content {
            margin: 2% auto;
            display: block;
            max-width: 98%;
            max-height: 96vh;
            cursor: zoom-in;
        }
        .image-modal-content.zoomed {
            max-width: none;
            max-height: none;
            width: auto;
            cursor: zoom-out;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 3001;
            transition: 0.3s;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
        }
        .zoom-hint {
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            margin-top: 8px;
            font-style: italic;
        }
        
        /* Custom confirm dialog */
        .custom-confirm {
            display: none;
            position: fixed;
            z-index: 2000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 280px;
        }
        .custom-confirm.show {
            display: block;
        }
        .custom-confirm-message {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 14px;
        }
        .custom-confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .custom-confirm-buttons .btn {
            padding: 6px 16px;
            font-size: 13px;
        }
        
        /* Responsive cho laptop - m√†n h√¨nh nh·ªè h∆°n */
        @media screen and (max-width: 1600px) {
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            body {
                padding: 0;
            }
            .header {
                padding: 20px 30px;
            }
            .header h1 {
                font-size: 26px;
                margin-bottom: 5px;
            }
            .header p {
                font-size: 13px;
            }
            .header-search {
                width: 250px;
                bottom: 12px;
                right: 20px;
            }
            .header-search input {
                padding: 8px 12px;
                font-size: 13px;
            }
            .main-content {
                grid-template-columns: 320px 1fr;
                max-height: calc(100vh - 120px);
            }
            .left-panel, .right-panel {
                max-height: calc(100vh - 120px);
                padding: 15px;
            }
            .form-group {
                margin-bottom: 12px;
            }
            .form-group label {
                font-size: 13px;
                margin-bottom: 5px;
            }
            .form-group input,
            .form-group select {
                padding: 7px;
                font-size: 13px;
            }
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }
            .format-section {
                padding: 10px;
                margin-top: 8px;
            }
            .format-section h4 {
                font-size: 13px;
                margin-bottom: 8px;
            }
            .poster-preview {
                width: 70px;
                height: 100px;
            }
            .movie-card {
                padding: 10px;
                border-radius: 6px;
            }
            .movie-card h3 {
                font-size: 14px;
            }
            .movie-info {
                font-size: 12px;
                gap: 6px;
                margin-top: 6px;
            }
            .age-badge {
                padding: 3px 7px;
                font-size: 10px;
            }
            .showtime-tag {
                padding: 4px 8px;
                font-size: 11px;
                gap: 5px;
            }
            .btn-danger {
                padding: 4px 8px;
                font-size: 11px;
            }
            .preview-section {
                margin-top: 20px;
                padding: 15px;
            }
            .preview-section h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            .right-panel h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            .import-export-section {
                gap: 8px;
                margin-bottom: 12px;
            }
        }
        
        .minute-option:hover, .hour-option:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="save-notification" id="saveNotification">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span>ƒê√£ l∆∞u phim th√†nh c√¥ng!</span>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage" onclick="toggleImageZoom(event)">
    </div>
    
    <!-- Custom Confirm Dialog -->
    <div class="custom-confirm" id="customConfirm">
        <div class="custom-confirm-message" id="confirmMessage"></div>
        <div class="custom-confirm-buttons">
            <button class="btn btn-secondary" onclick="closeCustomConfirm()">H·ªßy</button>
            <button class="btn btn-danger" onclick="confirmCustom()">X√°c nh·∫≠n</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üé¨ GALAXY CINEMA</h1>
            <p>C√¥ng c·ª• t·∫°o l·ªãch chi·∫øu phim</p>
            <div class="header-tools">
                <input type="text" id="searchBox" class="search-box" placeholder="üîç T√¨m ki·∫øm phim..." onkeyup="searchMovie()">
                <span class="header-movie-count" id="headerMovieCount">0 phim</span>
                <div class="menu-wrapper">
                    <button class="menu-btn" onclick="toggleDataMenu()">‚ò∞ Menu</button>
                    <div class="dropdown-menu" id="dataMenuDropdown">
                        <div class="dropdown-item" onclick="importInitialDataFromCloud()">‚òÅÔ∏è Import data ban ƒë·∫ßu</div>
                        <div class="dropdown-item" onclick="loadLatestFromCloud()">üì• T·∫£i data ƒë√£ l∆∞u</div>
                        <div class="dropdown-item" onclick="saveDataToCloud()">üíæ L∆∞u data ng√†y n√†y</div>
                        <div style="border-top: 1px solid #e5e7eb; margin: 4px 0;"></div>
                        <div class="dropdown-item" onclick="importData()">üì• Import JSON t·ª´ m√°y</div>
                        <div class="dropdown-item" onclick="exportData()">üì§ Export JSON</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <input type="file" id="importInput" class="hidden-input" accept=".json" onchange="handleImport(event)">

                <div class="form-group">
                    <label>Ch·ªçn r·∫°p:</label>
                    <select id="cinemaSelect">
                        <option value="GALAXY VINH">GALAXY VINH</option>
                        <option value="GALAXY CINE+ VINCOM PLAZA VINH">GALAXY CINE+ VINCOM PLAZA VINH</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        Ng√†y hi·ªÉn th·ªã: 
                        <span class="calendar-icon" onclick="document.getElementById('hiddenDateInput').showPicker()" title="Ch·ªçn t·ª´ l·ªãch">üìÖ</span>
                    </label>
                    <input type="date" id="hiddenDateInput" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="date-labels">
                        <span>Ng√†y</span>
                        <span>Th√°ng</span>
                        <span>NƒÉm</span>
                    </div>
                    <div class="custom-date-picker">
                        <select id="dateDay"></select>
                        <select id="dateMonth">
                            <option value="01">Th√°ng 1</option>
                            <option value="02">Th√°ng 2</option>
                            <option value="03">Th√°ng 3</option>
                            <option value="04">Th√°ng 4</option>
                            <option value="05">Th√°ng 5</option>
                            <option value="06">Th√°ng 6</option>
                            <option value="07">Th√°ng 7</option>
                            <option value="08">Th√°ng 8</option>
                            <option value="09">Th√°ng 9</option>
                            <option value="10">Th√°ng 10</option>
                            <option value="11">Th√°ng 11</option>
                            <option value="12">Th√°ng 12</option>
                        </select>
                        <select id="dateYear"></select>
                    </div>
                </div>

                <div class="form-group">
                    <label>T·∫£i l√™n ·∫£nh poster:</label>
                    <input type="file" id="posterInput" accept="image/*">
                    <img id="posterPreview" class="poster-preview" style="display:none;">
                </div>

                <div class="form-group">
                    <label>T√™n phim:</label>
                    <input type="text" id="movieTitle" placeholder="Nh·∫≠p t√™n phim...">
                </div>

                <div class="form-group">
                    <label>ƒê·ªãnh d·∫°ng:</label>
                    <select id="movieFormat">
                        <option value="2D">2D</option>
                        <option value="2D/3D">2D / 3D</option>
                        <option value="2D/Cine de Kids 2D">2D / Cine de Kids 2D</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ng√¥n ng·ªØ:</label>
                    <select id="movieLanguage">
                        <option value="Ph·ª• ƒë·ªÅ" selected>Ph·ª• ƒë·ªÅ</option>
                        <option value="L·ªìng Ti·∫øng">L·ªìng Ti·∫øng</option>
                        <option value="Ph·ª• ƒë·ªÅ/L·ªìng Ti·∫øng">Ph·ª• ƒë·ªÅ / L·ªìng Ti·∫øng</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Su·∫•t chi·∫øu:</label>
                    <label style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="sneakShow" style="cursor: pointer;"> SneakShow
                    </label>
                </div>

                <div class="form-group">
                    <label>ƒê·ªô tu·ªïi:</label>
                    <select id="ageRating">
                        <option value="P">P - M·ªçi l·ª©a tu·ªïi</option>
                        <option value="K">K - D∆∞·ªõi 13 tu·ªïi v·ªõi ph·ª• huynh</option>
                        <option value="T13">T13 - T·ª´ 13 tu·ªïi</option>
                        <option value="T16">T16 - T·ª´ 16 tu·ªïi</option>
                        <option value="T18">T18 - T·ª´ 18 tu·ªïi</option>
                    </select>
                </div>

                <!-- N√∫t reset t·∫•t c·∫£ gi·ªù chi·∫øu -->
                <div style="margin: 15px 0;">
                    <button class="btn btn-warning btn-block" onclick="showResetAllConfirm(this)" style="font-size: 15px;">
                        üîÑ Reset t·∫•t c·∫£ gi·ªù chi·∫øu
                    </button>
                </div>

                <div id="showtimeSections">
                    <!-- Sections will be generated dynamically based on format + language -->
                </div>

                <button class="btn btn-success btn-block" onclick="saveMovie()">üíæ L∆∞u phim</button>

                <div class="import-export-section" style="margin-top: 20px;">
                </div>
            </div>

            <div class="right-panel">
                <h2>Danh s√°ch phim ƒë√£ l∆∞u</h2>
                <div class="movies-list" id="moviesList"></div>

                <div class="preview-section">
                    <h2>Preview l·ªãch chi·∫øu</h2>
                    <div class="canvas-container">
                        <canvas id="scheduleCanvas" onclick="openImageModal()"></canvas>
                    </div>
                    <p class="zoom-hint">üí° B·∫•m v√†o ·∫£nh ƒë·ªÉ ph√≥ng to. Click v√†o ·∫£nh ph√≥ng to ƒë·ªÉ zoom 100% (ESC ƒë·ªÉ ƒë√≥ng)</p>
                    <button class="btn btn-success btn-block" style="margin-top: 15px;" onclick="downloadSchedule()">üì• T·∫£i xu·ªëng ·∫£nh PNG</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-shortcuts">
                <strong>‚å®Ô∏è Ph√≠m t·∫Øt:</strong> 
                <strong>Ctrl+S</strong> - T·∫£i PNG | 
                <strong>Ctrl+Z</strong> - Ho√†n t√°c | 
                <strong>Ctrl+Y</strong> - L√†m l·∫°i | 
                <strong>Ctrl+F</strong> - T√¨m ki·∫øm
            </div>
            <div>Developed by Tr·ªçng Hi·∫øu</div>
        </div>
    </div>

    <script>
        const CINEMA_CONFIG = {
            'GALAXY VINH': {
                name: 'GALAXY VINH',
                backgroundColor: '#1e3c8a',
                url: 'https://www.galaxycine.vn/rap-gia-ve/galaxy-vinh/'
            },
            'GALAXY CINE+ VINCOM PLAZA VINH': {
                name: 'GALAXY CINE+ VINCOM PLAZA VINH',
                backgroundColor: '#c96b2a',
                url: 'https://www.galaxycine.vn/rap-gia-ve/galaxy-cine-vincom-plaza-vinh/'
            }
        };

        let currentCinema = 'GALAXY VINH';
        let currentShowtimes = {};
        let currentPosterData = null;
        let moviesData = {};
        let editingMovieId = null;
        let selectedDate = '';
        
        // Undo/Redo history
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // Initialize custom date picker
        function initDatePicker() {
            const daySelect = document.getElementById('dateDay');
            const monthSelect = document.getElementById('dateMonth');
            const yearSelect = document.getElementById('dateYear');
            
            // Populate days (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = i;
                daySelect.appendChild(option);
            }
            
            // Populate years (2020-2030)
            const currentYear = new Date().getFullYear();
            for (let i = currentYear - 2; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            
            // Set today's date
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            
            daySelect.value = day;
            monthSelect.value = month;
            yearSelect.value = year;
            
            updateSelectedDate();
            
            // Add change listeners
            daySelect.addEventListener('change', updateSelectedDate);
            monthSelect.addEventListener('change', updateSelectedDate);
            yearSelect.addEventListener('change', updateSelectedDate);
        }
        
        function updateSelectedDate() {
            const day = document.getElementById('dateDay').value;
            const month = document.getElementById('dateMonth').value;
            const year = document.getElementById('dateYear').value;
            
            selectedDate = `${year}-${month}-${day}`;
            
            // Sync v·ªõi hidden date input
            document.getElementById('hiddenDateInput').value = selectedDate;
            
            generatePreview(moviesData[currentCinema] || []);
        }
        
        initDatePicker();

        // Sync hidden date input with custom picker
        document.getElementById('hiddenDateInput').addEventListener('change', function() {
            const dateValue = this.value; // yyyy-mm-dd
            if (dateValue) {
                const [year, month, day] = dateValue.split('-');
                document.getElementById('dateDay').value = day;
                document.getElementById('dateMonth').value = month;
                document.getElementById('dateYear').value = year;
                updateSelectedDate();
            }
        });

        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        selectedDate = dateStr;
        document.getElementById('hiddenDateInput').value = dateStr;

        // Image modal functions
        let currentResetFormat = null;
        
        function showResetConfirm(button, format) {
            const rect = button.getBoundingClientRect();
            const dialog = document.getElementById('customConfirm');
            const message = document.getElementById('confirmMessage');
            
            currentResetFormat = format;
            message.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ gi·ªù chi·∫øu ${format}?`;
            
            dialog.style.left = rect.left + 'px';
            dialog.style.top = (rect.top - 80) + 'px';
            dialog.classList.add('show');
        }
        
        function closeCustomConfirm() {
            document.getElementById('customConfirm').classList.remove('show');
            currentResetFormat = null;
        }
        
        function confirmCustom() {
            if (currentResetFormat) {
                if (currentResetFormat === 'ALL') {
                    // Reset t·∫•t c·∫£
                    Object.keys(currentShowtimes).forEach(format => {
                        currentShowtimes[format] = [];
                    });
                    updateShowtimeSections();
                    console.log('‚úÖ ƒê√£ reset t·∫•t c·∫£ gi·ªù chi·∫øu');
                } else {
                    // Reset 1 format
                    currentShowtimes[currentResetFormat] = [];
                    renderShowtimes(currentResetFormat);
                }
            }
            closeCustomConfirm();
        }
        
        function showResetAllConfirm(button) {
            const rect = button.getBoundingClientRect();
            const dialog = document.getElementById('customConfirm');
            const message = document.getElementById('confirmMessage');
            
            currentResetFormat = 'ALL';
            message.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ gi·ªù chi·∫øu?`;
            
            dialog.style.left = rect.left + 'px';
            dialog.style.top = (rect.bottom + 10) + 'px'; // Hi·ªán ngay d∆∞·ªõi n√∫t
            dialog.classList.add('show');
        }
        
        function openImageModal() {
            const canvas = document.getElementById('scheduleCanvas');
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modalImg.src = canvas.toDataURL('image/png');
            modalImg.classList.remove('zoomed');
            modal.classList.add('show');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
        }
        
        function toggleImageZoom(event) {
            event.stopPropagation();
            const img = document.getElementById('modalImage');
            img.classList.toggle('zoomed');
        }

        // ESC key to close modal and custom confirm
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                closeCustomConfirm();
            }
            
            // Q W E R - Quick minute shortcuts (focus-based)
            // A S D - Quick hour shortcuts (7, 8, 9) (focus-based)
            // Space - Add showtime (focus-based)
            if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                const activeElement = document.activeElement;
                const isTyping = activeElement.tagName === 'INPUT' || 
                                 activeElement.tagName === 'TEXTAREA';
                
                if (!isTyping) {
                    const key = e.key.toLowerCase();
                    
                    // Skip if Unikey is composing (ƒëang g√µ d·∫•u)
                    if (e.isComposing || e.keyCode === 229) {
                        return;
                    }
                    
                    console.log('Key:', key, 'Code:', e.code, 'Composing:', e.isComposing); // DEBUG
                    
                    // Space - Add showtime LU√îN (l·∫•y gi√° tr·ªã hi·ªán t·∫°i)
                    if (key === ' ') {
                        e.preventDefault();
                        
                        // Find ANY section that exists and click its button
                        // Priority: Check if any dropdown is open first
                        let openDropdown = document.querySelector('[id^="minuteDropdown"][data-open="true"]');
                        
                        if (!openDropdown) {
                            openDropdown = document.querySelector('[id^="hourDropdown"][data-open="true"]');
                        }
                        
                        if (openDropdown) {
                            // Close dropdown first
                            openDropdown.style.display = 'none';
                            openDropdown.dataset.open = 'false';
                            
                            // Click Th√™m button for this section
                            const timePicker = openDropdown.closest('.format-section')?.querySelector('.time-picker');
                            if (timePicker) {
                                const btn = timePicker.querySelector('.btn-primary');
                                if (btn) {
                                    btn.click();
                                    console.log('Space: Saved (dropdown was open)');
                                }
                            }
                        } else {
                            // No dropdown open - click ALL Th√™m buttons (l∆∞u t·∫•t c·∫£ sections)
                            const allButtons = document.querySelectorAll('.time-picker .btn-primary');
                            let clicked = false;
                            allButtons.forEach(btn => {
                                if (btn.textContent.includes('Th√™m')) {
                                    btn.click();
                                    clicked = true;
                                }
                            });
                            if (clicked) {
                                console.log('Space: Saved ALL sections');
                            }
                        }
                    }
                    // Hour shortcuts (A S D + Numbers) - focus-based
                    else if (key === 'a' || key === 'ƒÉ' || key === '√¢') {
                        e.preventDefault();
                        
                        const openDropdown = document.querySelector('[id^="hourDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectHour(openDropdown.dataset.sectionId, '07');
                        }
                    }
                    else if (key === 's') {
                        e.preventDefault();
                        
                        const openDropdown = document.querySelector('[id^="hourDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectHour(openDropdown.dataset.sectionId, '08');
                        }
                    }
                    else if (key === 'd' || key === 'ƒë') {
                        e.preventDefault();
                        
                        const openDropdown = document.querySelector('[id^="hourDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectHour(openDropdown.dataset.sectionId, '09');
                        }
                    }
                    // Number keys to cycle through hours
                    else if (key >= '0' && key <= '9') {
                        const openDropdown = document.querySelector('[id^="hourDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            e.preventDefault();
                            const sectionId = openDropdown.dataset.sectionId;
                            const display = document.getElementById(`hourDisplay${sectionId}`);
                            const currentHour = parseInt(display.dataset.currentValue);
                            const pressedDigit = parseInt(key);
                            
                            // Get the tens digit (1 for 10-19, 2 for 20-23)
                            const currentTens = Math.floor(currentHour / 10);
                            const currentOnes = currentHour % 10;
                            
                            let newHour;
                            
                            // If pressed digit is 1: cycle 10->11->12...->19->10
                            if (pressedDigit === 1) {
                                if (currentTens === 1) {
                                    // Already in 10-19 range, increment
                                    newHour = currentHour + 1;
                                    if (newHour > 19) newHour = 10; // Wrap to 10
                                } else {
                                    // Jump to 10
                                    newHour = 10;
                                }
                            }
                            // If pressed digit is 2: cycle 20->21->22->23->20
                            else if (pressedDigit === 2) {
                                if (currentTens === 2) {
                                    // Already in 20-23 range, increment
                                    newHour = currentHour + 1;
                                    if (newHour > 23) newHour = 20; // Wrap to 20
                                } else {
                                    // Jump to 20
                                    newHour = 20;
                                }
                            }
                            // Other digits: add to current hour
                            else if (pressedDigit >= 0 && pressedDigit <= 9) {
                                newHour = currentHour + pressedDigit;
                                if (newHour > 23) newHour = 23;
                                if (newHour < 7) newHour = 7;
                            }
                            
                            if (newHour !== undefined) {
                                selectHour(sectionId, newHour.toString().padStart(2, '0'));
                            }
                        }
                    }
                    // Minute shortcuts (Q W E R) - focus-based (ch·ªâ dropdown ƒëang m·ªü)
                    else if (key === 'q') {
                        e.preventDefault();
                        
                        // Find which minute dropdown is open
                        const openDropdown = document.querySelector('[id^="minuteDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectMinute(openDropdown.dataset.sectionId, '00'); // ƒê√≥ng dropdown
                        }
                    }
                    else if (key === 'w' || key === '∆∞') {
                        e.preventDefault();
                        console.log('W pressed! key:', key, 'code:', e.code); // DEBUG
                        
                        const openDropdown = document.querySelector('[id^="minuteDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            console.log('Found dropdown, selecting 15...'); // DEBUG
                            selectMinute(openDropdown.dataset.sectionId, '15'); // ƒê√≥ng dropdown
                        } else {
                            console.log('No dropdown open!'); // DEBUG
                        }
                    }
                    else if (key === 'e' || key === '√™') {
                        e.preventDefault();
                        
                        const openDropdown = document.querySelector('[id^="minuteDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectMinute(openDropdown.dataset.sectionId, '30'); // ƒê√≥ng dropdown
                        }
                    }
                    else if (key === 'r') {
                        e.preventDefault();
                        
                        const openDropdown = document.querySelector('[id^="minuteDropdown"][data-open="true"]');
                        if (openDropdown && openDropdown.dataset.sectionId) {
                            selectMinute(openDropdown.dataset.sectionId, '45'); // ƒê√≥ng dropdown
                        }
                    }
                }
            }
            
            // Ctrl+S - Download
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                downloadSchedule();
            }
            
            // Ctrl+Z - Undo
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            // Ctrl+Y - Redo
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
            
            // Ctrl+F - Focus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
        });

        // Dynamic showtime sections based on format + language
        function updateShowtimeSections() {
            const format = document.getElementById('movieFormat').value;
            const language = document.getElementById('movieLanguage').value;
            const container = document.getElementById('showtimeSections');
            container.innerHTML = '';
            
            // Backup current showtimes before clearing
            const oldShowtimes = JSON.parse(JSON.stringify(currentShowtimes));
            
            const sections = [];
            
            // Determine which format sections to show
            if (format === '2D/3D') {
                sections.push('2D', '3D');
            } else if (format === '2D/Cine de Kids 2D') {
                sections.push('2D', 'Cine de Kids 2D');
            } else {
                // Default: 2D
                sections.push(format || '2D');
            }
            
            // Language is now required, split each section by language
            const finalSections = [];
            if (language === 'Ph·ª• ƒë·ªÅ/L·ªìng Ti·∫øng') {
                sections.forEach(s => {
                    finalSections.push(s + ' Ph·ª• ƒë·ªÅ');
                    finalSections.push(s + ' L·ªìng Ti·∫øng');
                });
            } else if (language === 'Ph·ª• ƒë·ªÅ') {
                sections.forEach(s => finalSections.push(s + ' Ph·ª• ƒë·ªÅ'));
            } else if (language === 'L·ªìng Ti·∫øng') {
                sections.forEach(s => finalSections.push(s + ' L·ªìng Ti·∫øng'));
            } else {
                // Fallback - shouldn't happen since language is required now
                finalSections.push(...sections);
            }
            
            // Create sections
            finalSections.forEach(sectionName => {
                const sectionId = sectionName.replace(/\s+/g, '');
                
                // Try to find data from old keys
                if (!currentShowtimes[sectionName]) {
                    currentShowtimes[sectionName] = [];
                }
                
                // Migrate data: if new section is "2D L·ªìng Ti·∫øng" but old data has "2D", copy it
                if (oldShowtimes[sectionName] && oldShowtimes[sectionName].length > 0) {
                    // Exact match - keep it
                    currentShowtimes[sectionName] = [...oldShowtimes[sectionName]];
                } else {
                    // Try to find base format match
                    // Example: "2D L·ªìng Ti·∫øng" should try "2D", "2D Ph·ª• ƒë·ªÅ", etc
                    const baseFormat = sectionName.replace(' Ph·ª• ƒë·ªÅ', '').replace(' L·ªìng Ti·∫øng', '');
                    
                    // Check if old data has this base format
                    if (oldShowtimes[baseFormat] && oldShowtimes[baseFormat].length > 0) {
                        currentShowtimes[sectionName] = [...oldShowtimes[baseFormat]];
                    }
                }
                
                const section = document.createElement('div');
                section.className = 'format-section';
                section.innerHTML = `
                    <h4>Gi·ªù chi·∫øu ${sectionName}:</h4>
                    <div class="form-group">
                        <div class="time-picker" style="position: relative;">
                            <div style="position: relative; display: inline-block;">
                                <div id="hourDisplay${sectionId}" style="display: inline-block; padding: 8px 20px 8px 8px; border: 2px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; width: 60px; height: 38px; box-sizing: border-box; position: relative; text-align: center; line-height: 22px; font-size: 14px;" onclick="toggleHourDropdown('${sectionId}')">
                                    <span id="hourValue${sectionId}">07</span>
                                    <span style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 10px;">‚ñº</span>
                                </div>
                                <div id="hourDropdown${sectionId}" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 2px solid #d1d5db; border-radius: 6px; margin-top: 2px; width: 60px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto;">
                                    <div id="hourOptions${sectionId}">
                                        <div class="hour-option" data-value="07" onclick="selectHour('${sectionId}', '07')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; white-space: nowrap;">07 <span style="color: #9ca3af; font-size: 11px;">(A)</span></div>
                                        <div class="hour-option" data-value="08" onclick="selectHour('${sectionId}', '08')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; white-space: nowrap;">08 <span style="color: #9ca3af; font-size: 11px;">(S)</span></div>
                                        <div class="hour-option" data-value="09" onclick="selectHour('${sectionId}', '09')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px; white-space: nowrap;">09 <span style="color: #9ca3af; font-size: 11px;">(D)</span></div>
                                        <div class="hour-option" data-value="10" onclick="selectHour('${sectionId}', '10')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">10</div>
                                        <div class="hour-option" data-value="11" onclick="selectHour('${sectionId}', '11')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">11</div>
                                        <div class="hour-option" data-value="12" onclick="selectHour('${sectionId}', '12')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">12</div>
                                        <div class="hour-option" data-value="13" onclick="selectHour('${sectionId}', '13')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">13</div>
                                        <div class="hour-option" data-value="14" onclick="selectHour('${sectionId}', '14')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">14</div>
                                        <div class="hour-option" data-value="15" onclick="selectHour('${sectionId}', '15')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">15</div>
                                        <div class="hour-option" data-value="16" onclick="selectHour('${sectionId}', '16')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">16</div>
                                        <div class="hour-option" data-value="17" onclick="selectHour('${sectionId}', '17')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">17</div>
                                        <div class="hour-option" data-value="18" onclick="selectHour('${sectionId}', '18')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">18</div>
                                        <div class="hour-option" data-value="19" onclick="selectHour('${sectionId}', '19')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">19</div>
                                        <div class="hour-option" data-value="20" onclick="selectHour('${sectionId}', '20')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">20</div>
                                        <div class="hour-option" data-value="21" onclick="selectHour('${sectionId}', '21')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">21</div>
                                        <div class="hour-option" data-value="22" onclick="selectHour('${sectionId}', '22')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">22</div>
                                        <div class="hour-option" data-value="23" onclick="selectHour('${sectionId}', '23')" style="padding: 6px 8px; cursor: pointer; text-align: center; font-size: 14px;">23</div>
                                    </div>
                                </div>
                            </div>
                            <div style="position: relative; display: inline-block;">
                                <div id="minuteDisplay${sectionId}" style="display: inline-block; padding: 8px 20px 8px 8px; border: 2px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; width: 60px; height: 38px; box-sizing: border-box; position: relative; text-align: center; line-height: 22px; font-size: 14px;" onclick="toggleMinuteDropdown('${sectionId}')">
                                    <span id="minuteValue${sectionId}">00</span>
                                    <span style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 10px;">‚ñº</span>
                                </div>
                                <div id="minuteDropdown${sectionId}" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 2px solid #d1d5db; border-radius: 6px; margin-top: 2px; width: 60px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <!-- Fixed toggle button at TOP with sticky -->
                                    <div style="position: sticky; top: 0; background: white; border-bottom: 2px solid #d1d5db; z-index: 10;">
                                        <div id="minuteToggle${sectionId}" onclick="toggleMinuteMode('${sectionId}')" style="padding: 5px 2px; cursor: pointer; font-weight: 600; color: #3b82f6; text-align: center; font-size: 10px; white-space: nowrap;">‚ñº Chi ti·∫øt</div>
                                    </div>
                                    <!-- Scrollable options area -->
                                    <div id="minuteOptionsScroll${sectionId}" style="max-height: 150px; overflow-y: auto;">
                                        <div id="minuteOptions${sectionId}">
                                            <div class="minute-option" data-value="00" onclick="selectMinute('${sectionId}', '00')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">
                                                00 <span style="color: #9ca3af; font-size: 11px;">(Q)</span>
                                            </div>
                                            <div class="minute-option" data-value="15" onclick="selectMinute('${sectionId}', '15')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">
                                                15 <span style="color: #9ca3af; font-size: 11px;">(W)</span>
                                            </div>
                                            <div class="minute-option" data-value="30" onclick="selectMinute('${sectionId}', '30')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">
                                                30 <span style="color: #9ca3af; font-size: 11px;">(E)</span>
                                            </div>
                                            <div class="minute-option" data-value="45" onclick="selectMinute('${sectionId}', '45')" style="padding: 6px 8px; cursor: pointer; text-align: center; font-size: 14px;">
                                                45 <span style="color: #9ca3af; font-size: 11px;">(R)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="addShowtime('${sectionName}')">Th√™m</button>
                        </div>
                        <div class="showtimes-list" id="showtimesList${sectionId}"></div>
                    </div>
                `;
                container.appendChild(section);
                
                // Store current hour and minute values
                const hourDisplay = document.getElementById(`hourDisplay${sectionId}`);
                hourDisplay.dataset.currentValue = '07';
                
                const minuteDisplay = document.getElementById(`minuteDisplay${sectionId}`);
                minuteDisplay.dataset.currentValue = '00';
                minuteDisplay.dataset.mode = 'quick';
                
                // Render existing showtimes
                renderShowtimes(sectionName);
            });
        }
        
        // Toggle minute dropdown visibility
        // Toggle hour dropdown
        window.toggleHourDropdown = function(sectionId) {
            const dropdown = document.getElementById(`hourDropdown${sectionId}`);
            
            // Close all other hour dropdowns
            document.querySelectorAll('[id^="hourDropdown"]').forEach(d => {
                if (d.id !== `hourDropdown${sectionId}`) {
                    d.style.display = 'none';
                    d.dataset.open = 'false';
                }
            });
            
            // Close all minute dropdowns
            document.querySelectorAll('[id^="minuteDropdown"]').forEach(d => {
                d.style.display = 'none';
                d.dataset.open = 'false';
            });
            
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            dropdown.dataset.open = isOpen ? 'false' : 'true';
            dropdown.dataset.sectionId = sectionId;
        };
        
        // Select an hour value
        window.selectHour = function(sectionId, value, keepOpen = false) {
            const display = document.getElementById(`hourDisplay${sectionId}`);
            const valueSpan = document.getElementById(`hourValue${sectionId}`);
            const dropdown = document.getElementById(`hourDropdown${sectionId}`);
            
            valueSpan.textContent = value;
            display.dataset.currentValue = value;
            
            if (!keepOpen) {
                dropdown.style.display = 'none';
                dropdown.dataset.open = 'false';
            }
        };
        
        window.toggleMinuteDropdown = function(sectionId) {
            const dropdown = document.getElementById(`minuteDropdown${sectionId}`);
            
            // Close all other dropdowns first
            document.querySelectorAll('[id^="minuteDropdown"]').forEach(d => {
                if (d.id !== `minuteDropdown${sectionId}`) {
                    d.style.display = 'none';
                    d.dataset.open = 'false';
                }
            });
            
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            dropdown.dataset.open = isOpen ? 'false' : 'true';
            dropdown.dataset.sectionId = sectionId; // Store sectionId for keyboard access
        };
        
        // Select a minute value
        window.selectMinute = function(sectionId, value, keepOpen = false) {
            const display = document.getElementById(`minuteDisplay${sectionId}`);
            const valueSpan = document.getElementById(`minuteValue${sectionId}`);
            const dropdown = document.getElementById(`minuteDropdown${sectionId}`);
            
            valueSpan.textContent = value;
            display.dataset.currentValue = value;
            
            if (!keepOpen) {
                dropdown.style.display = 'none';
                dropdown.dataset.open = 'false'; // Mark as closed
            }
        };
        
        // Toggle between quick and full mode
        window.toggleMinuteMode = function(sectionId) {
            const display = document.getElementById(`minuteDisplay${sectionId}`);
            const optionsContainer = document.getElementById(`minuteOptions${sectionId}`);
            const toggleButton = document.getElementById(`minuteToggle${sectionId}`);
            const scrollContainer = document.getElementById(`minuteOptionsScroll${sectionId}`);
            const currentMode = display.dataset.mode || 'quick';
            
            if (currentMode === 'quick') {
                // Switch to full mode
                let html = '';
                
                // All minutes 00-59
                for (let i = 0; i <= 59; i++) {
                    const val = i.toString().padStart(2, '0');
                    html += '<div class="minute-option" data-value="' + val + '" onclick="selectMinute(\'' + sectionId + '\', \'' + val + '\')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">' + val + '</div>';
                }
                
                optionsContainer.innerHTML = html;
                toggleButton.innerHTML = '‚ñ≤ Thu g·ªçn';
                toggleButton.style.fontSize = '10px';
                toggleButton.style.whiteSpace = 'nowrap';
                scrollContainer.style.maxHeight = '200px';
                display.dataset.mode = 'full';
                
            } else {
                // Switch to quick mode
                let html = '';
                html += '<div class="minute-option" data-value="00" onclick="selectMinute(\'' + sectionId + '\', \'00\')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">00</div>';
                html += '<div class="minute-option" data-value="15" onclick="selectMinute(\'' + sectionId + '\', \'15\')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">15</div>';
                html += '<div class="minute-option" data-value="30" onclick="selectMinute(\'' + sectionId + '\', \'30\')" style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 14px;">30</div>';
                html += '<div class="minute-option" data-value="45" onclick="selectMinute(\'' + sectionId + '\', \'45\')" style="padding: 6px 8px; cursor: pointer; text-align: center; font-size: 14px;">45</div>';
                
                optionsContainer.innerHTML = html;
                toggleButton.innerHTML = '‚ñº Chi ti·∫øt';
                toggleButton.style.fontSize = '10px';
                toggleButton.style.whiteSpace = 'nowrap';
                scrollContainer.style.maxHeight = '150px';
                display.dataset.mode = 'quick';
            }
        }
        
        document.getElementById('movieFormat').addEventListener('change', updateShowtimeSections);
        document.getElementById('movieLanguage').addEventListener('change', updateShowtimeSections);
        
        // Initialize on page load
        updateShowtimeSections();

        // History management
        function saveToHistory() {
            const state = JSON.parse(JSON.stringify(moviesData));
            
            // Remove future history if we're not at the end
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            history.push(state);
            
            // Limit history size
            if (history.length > MAX_HISTORY) {
                history.shift();
            } else {
                historyIndex++;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                moviesData = JSON.parse(JSON.stringify(history[historyIndex]));
                saveToLocalStorage();
                loadData();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                moviesData = JSON.parse(JSON.stringify(history[historyIndex]));
                saveToLocalStorage();
                loadData();
            }
        }

        function searchMovie() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const movieCards = document.querySelectorAll('.movie-card');
            
            movieCards.forEach(card => {
                card.classList.remove('highlight');
            });
            
            if (searchTerm === '') {
                return;
            }
            
            const movies = moviesData[currentCinema] || [];
            let foundIndex = -1;
            
            for (let i = 0; i < movies.length; i++) {
                if (movies[i].title.toLowerCase().includes(searchTerm)) {
                    foundIndex = i;
                    break;
                }
            }
            
            if (foundIndex !== -1 && movieCards[foundIndex]) {
                movieCards[foundIndex].classList.add('highlight');
                movieCards[foundIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function importData() {
            const dropdown = document.getElementById('dataMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            document.getElementById('importInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // MIGRATE OLD DATA FORMAT
                    Object.keys(imported).forEach(cinema => {
                        if (imported[cinema]) {
                            imported[cinema].forEach(movie => {
                                if (movie.showtimes) {
                                    const oldKeys = Object.keys(movie.showtimes);
                                    const newShowtimes = {};
                                    let migrated = false;
                                    
                                    oldKeys.forEach(key => {
                                        // Check if key already has language
                                        if (!key.includes('Ph·ª• ƒë·ªÅ') && !key.includes('L·ªìng Ti·∫øng')) {
                                            // Old format - add default language
                                            const newKey = key + ' Ph·ª• ƒë·ªÅ';
                                            newShowtimes[newKey] = movie.showtimes[key];
                                            migrated = true;
                                        } else {
                                            // Already new format
                                            newShowtimes[key] = movie.showtimes[key];
                                        }
                                    });
                                    
                                    if (migrated) {
                                        movie.showtimes = newShowtimes;
                                        if (!movie.language) movie.language = 'Ph·ª• ƒë·ªÅ';
                                        if (!movie.format) movie.format = '2D';
                                    }
                                }
                            });
                        }
                    });
                    
                    moviesData = imported;
                    saveToHistory();
                    saveToLocalStorage();
                    loadData();
                    showToast('‚úÖ ƒê√£ n·∫°p d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                } catch (error) {
                    showToast('‚ùå L·ªói: File JSON kh√¥ng h·ª£p l·ªá!', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== FIREBASE CLOUD STORAGE ====================
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCIThlf3qnCWGypqVLF6MtDtOLDtE7R4kw",
            authDomain: "galaxy-cinema-tool.firebaseapp.com",
            databaseURL: "https://galaxy-cinema-tool-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "galaxy-cinema-tool",
            storageBucket: "galaxy-cinema-tool.firebasestorage.app",
            messagingSenderId: "126880410412",
            appId: "1:126880410412:web:89ad2d9c80ee9ca4bb5a89"
        };
        
        // Initialize Firebase after page load
        let database;
        
        // Wait for Firebase SDK to load
        function initFirebase() {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('‚úÖ Firebase initialized');
            } else {
                console.error('‚ùå Firebase SDK not loaded');
                setTimeout(initFirebase, 100);
            }
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFirebase);
        } else {
            initFirebase();
        }
        
        // Import data ban ƒë·∫ßu t·ª´ cloud
        async function importInitialDataFromCloud() {
            const dropdown = document.getElementById('dataMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            if (!database) {
                showToast('‚ùå Firebase ch∆∞a s·∫µn s√†ng!', 'error');
                return;
            }
            
            showToast('‚òÅÔ∏è ƒêang t·∫£i data ban ƒë·∫ßu...', 'info');
            
            try {
                const snapshot = await database.ref('initial-template').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    showToast('‚ùå Ch∆∞a c√≥ data ban ƒë·∫ßu!', 'error');
                    return;
                }
                
                moviesData = data;
                saveToHistory();
                saveToLocalStorage();
                loadData();
                
                showToast('‚úÖ ƒê√£ t·∫£i data ban ƒë·∫ßu th√†nh c√¥ng!', 'success');
                console.log('‚úÖ Imported initial data from Firebase');
            } catch (error) {
                showToast('‚ùå L·ªói: ' + error.message, 'error');
                console.error('Firebase import error:', error);
            }
        }
        
        // T·∫£i data ƒë√£ l∆∞u (ng√†y tr∆∞·ªõc) t·ª´ cloud
        async function loadLatestFromCloud() {
            const dropdown = document.getElementById('dataMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            if (!database) {
                showToast('‚ùå Firebase ch∆∞a s·∫µn s√†ng!', 'error');
                return;
            }
            
            showToast('‚òÅÔ∏è ƒêang t·∫£i data ƒë√£ l∆∞u...', 'info');
            
            try {
                const snapshot = await database.ref('latest-data').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    showToast('‚ùå Ch∆∞a c√≥ data ƒë√£ l∆∞u!', 'error');
                    return;
                }
                
                moviesData = data;
                saveToHistory();
                saveToLocalStorage();
                loadData();
                
                showToast('‚úÖ ƒê√£ t·∫£i data ƒë√£ l∆∞u th√†nh c√¥ng!', 'success');
                console.log('‚úÖ Loaded latest data from Firebase');
            } catch (error) {
                showToast('‚ùå L·ªói: ' + error.message, 'error');
                console.error('Firebase load error:', error);
            }
        }
        
        // L∆∞u data ng√†y n√†y l√™n cloud
        async function saveDataToCloud() {
            const dropdown = document.getElementById('dataMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            if (!database) {
                showToast('‚ùå Firebase ch∆∞a s·∫µn s√†ng!', 'error');
                return;
            }
            
            if (!confirm('L∆∞u data ng√†y n√†y l√™n cloud?\n\n‚ö†Ô∏è S·∫Ω ghi ƒë√® data c≈© v√† c·∫£ team s·∫Ω th·∫•y data m·ªõi n√†y.')) {
                return;
            }
            
            showToast('‚òÅÔ∏è ƒêang l∆∞u l√™n cloud...', 'info');
            
            try {
                await database.ref('latest-data').set(moviesData);
                
                showToast('‚úÖ ƒê√£ l∆∞u data l√™n cloud th√†nh c√¥ng!', 'success');
                console.log('‚úÖ Saved data to Firebase');
            } catch (error) {
                showToast('‚ùå L·ªói: ' + error.message, 'error');
                console.error('Firebase save error:', error);
            }
        }

        async function exportData() {
            const dropdown = document.getElementById('dataMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            const dataStr = JSON.stringify(moviesData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            
            // Format: data dd-mm-yyyy TenRap.json
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const dateStr = `${day}-${month}-${year}`;
            const cinemaName = currentCinema.replace(/GALAXY |CINE\+ /g, '').trim();
            const fileName = `data ${dateStr} ${cinemaName}.json`;
            
            // Try File System Access API for folder selection
            if ('showSaveFilePicker' in window) {
                try {
                    const options = {
                        suggestedName: fileName,
                        types: [{
                            description: 'JSON Files',
                            accept: {'application/json': ['.json']}
                        }]
                    };
                    
                    // Use saved JSON folder if available
                    if (lastJSONFolderHandle) {
                        try {
                            const permission = await lastJSONFolderHandle.queryPermission({ mode: 'readwrite' });
                            if (permission === 'granted') {
                                options.startIn = lastJSONFolderHandle;
                                console.log('üìÇ S·ª≠ d·ª•ng JSON folder ƒë√£ l∆∞u');
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ d√πng JSON folder c≈©:', e);
                        }
                    }
                    
                    const handle = await window.showSaveFilePicker(options);
                    
                    // Save parent folder for next time
                    try {
                        const parent = await handle.getParent();
                        lastJSONFolderHandle = parent;
                        await saveFolderHandle('jsonFolder', parent);
                        console.log('‚úÖ ƒê√£ l∆∞u JSON folder');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u JSON folder:', e);
                    }
                    
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Export failed:', err);
                        showToast('‚ùå Xu·∫•t d·ªØ li·ªáu th·∫•t b·∫°i!', 'error');
                    }
                }
            } else {
                // Fallback to traditional download
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = fileName;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
            }
        }

        function saveToLocalStorage() {
            // Do nothing - only save on download
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('galaxyCinema_completeState');
                
                if (!saved) {
                    console.log('No saved data - initializing empty');
                    moviesData = {'GALAXY VINH': [], 'GALAXY CINE+ VINCOM PLAZA VINH': []};
                    history = [JSON.parse(JSON.stringify(moviesData))];
                    historyIndex = 0;
                    return;
                }
                
                const completeState = JSON.parse(saved);
                
                // Restore selectedDate FIRST
                selectedDate = completeState.selectedDate;
                
                // Restore moviesData SECOND
                moviesData = completeState.moviesData;
                
                // Ensure both cinemas exist
                if (!moviesData['GALAXY VINH']) moviesData['GALAXY VINH'] = [];
                if (!moviesData['GALAXY CINE+ VINCOM PLAZA VINH']) moviesData['GALAXY CINE+ VINCOM PLAZA VINH'] = [];
                
                // MIGRATE OLD DATA FORMAT
                Object.keys(moviesData).forEach(cinema => {
                    moviesData[cinema].forEach(movie => {
                        if (movie.showtimes) {
                            const oldKeys = Object.keys(movie.showtimes);
                            const newShowtimes = {};
                            let migrated = false;
                            
                            oldKeys.forEach(key => {
                                // Check if key already has language
                                if (!key.includes('Ph·ª• ƒë·ªÅ') && !key.includes('L·ªìng Ti·∫øng')) {
                                    // Old format - add default language
                                    const newKey = key + ' Ph·ª• ƒë·ªÅ';
                                    newShowtimes[newKey] = movie.showtimes[key];
                                    migrated = true;
                                    console.log(`Migrated: "${key}" ‚Üí "${newKey}"`);
                                } else {
                                    // Already new format
                                    newShowtimes[key] = movie.showtimes[key];
                                }
                            });
                            
                            if (migrated) {
                                movie.showtimes = newShowtimes;
                                // Also set language if not set
                                if (!movie.language) {
                                    movie.language = 'Ph·ª• ƒë·ªÅ';
                                }
                                // Set format if not set
                                if (!movie.format) {
                                    movie.format = '2D';
                                }
                            }
                        }
                    });
                });
                
                console.log('‚úÖ Loaded complete state:', completeState);
                
                // Update UI dropdowns
                const [year, month, day] = selectedDate.split('-');
                const daySelect = document.getElementById('dateDay');
                const monthSelect = document.getElementById('dateMonth');
                const yearSelect = document.getElementById('dateYear');
                const hiddenInput = document.getElementById('hiddenDateInput');
                
                if (daySelect) daySelect.value = day;
                if (monthSelect) monthSelect.value = month;
                if (yearSelect) yearSelect.value = year;
                if (hiddenInput) hiddenInput.value = selectedDate;
                
                // Initialize history
                history = [JSON.parse(JSON.stringify(moviesData))];
                historyIndex = 0;
                
            } catch (e) {
                console.error('‚ùå Load error:', e);
                moviesData = {'GALAXY VINH': [], 'GALAXY CINE+ VINCOM PLAZA VINH': []};
                history = [JSON.parse(JSON.stringify(moviesData))];
                historyIndex = 0;
            }
        }

        function loadData() {
            const cinema = document.getElementById('cinemaSelect').value;
            currentCinema = cinema;
            const data = moviesData[cinema] || [];
            renderMoviesList(data);
            generatePreview(data);
        }

        document.getElementById('posterInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentPosterData = event.target.result;
                    document.getElementById('posterPreview').src = currentPosterData;
                    document.getElementById('posterPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function addShowtime(format) {
            const sectionId = format.replace(/\s+/g, '');
            const hourDisplay = document.getElementById('hourDisplay' + sectionId);
            const hour = hourDisplay.dataset.currentValue;
            const minuteDisplay = document.getElementById('minuteDisplay' + sectionId);
            const minute = minuteDisplay.dataset.currentValue;
            
            const time = `${hour}:${minute}`;
            
            if (!currentShowtimes[format]) {
                currentShowtimes[format] = [];
            }
            
            if (!currentShowtimes[format].includes(time)) {
                currentShowtimes[format].push(time);
                currentShowtimes[format].sort();
                renderShowtimes(format);
            }
        }

        function removeShowtime(format, time) {
            currentShowtimes[format] = currentShowtimes[format].filter(t => t !== time);
            renderShowtimes(format);
        }

        function renderShowtimes(format) {
            const sectionId = format.replace(/\s+/g, '');
            const container = document.getElementById('showtimesList' + sectionId);
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!currentShowtimes[format]) {
                currentShowtimes[format] = [];
            }
            
            currentShowtimes[format].forEach(time => {
                const tag = document.createElement('div');
                tag.className = 'showtime-tag';
                tag.innerHTML = `
                    <span>${time}</span>
                    <button class="btn-danger" onclick="removeShowtime('${format}', '${time}')">‚úï</button>
                `;
                container.appendChild(tag);
            });
        }

        function saveMovie() {
            const title = document.getElementById('movieTitle').value.trim();
            const format = document.getElementById('movieFormat').value;
            const language = document.getElementById('movieLanguage').value;
            const ageRating = document.getElementById('ageRating').value;
            const sneakShow = document.getElementById('sneakShow').checked;

            console.log('=== SAVE MOVIE DEBUG ===');
            console.log('Title:', title);
            console.log('Format:', format);
            console.log('Language:', language);
            console.log('Poster:', currentPosterData ? 'OK' : 'MISSING');
            console.log('currentShowtimes:', currentShowtimes);

            if (!title || !currentPosterData) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                console.error('‚ùå Missing title or poster');
                return;
            }

            // Check if any showtime exists (dynamic)
            const hasShowtimes = Object.keys(currentShowtimes).some(key => 
                currentShowtimes[key] && currentShowtimes[key].length > 0
            );
            
            console.log('hasShowtimes:', hasShowtimes);
            console.log('Showtime keys with data:', Object.keys(currentShowtimes).filter(k => currentShowtimes[k] && currentShowtimes[k].length > 0));
            
            if (!hasShowtimes) {
                alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt gi·ªù chi·∫øu!');
                console.error('‚ùå No showtimes found');
                return;
            }

            let subtitle = '';
            let parts = [];
            
            if (format) parts.push(format);
            if (language) parts.push(language);
            if (sneakShow) parts.push('SneakShow');
            
            if (parts.length > 0) {
                subtitle = parts.join(', ');
            }

            const currentDateForMovie = new Date().toISOString().split('T')[0];

            const movie = {
                id: editingMovieId || Date.now(),
                title,
                subtitle,
                format,
                language,
                sneakShow,
                ageRating,
                poster: currentPosterData,
                dateCreated: currentDateForMovie,
                showtimes: JSON.parse(JSON.stringify(currentShowtimes)) // Copy all showtimes
            };

            console.log('Movie object created:', movie);

            if (!moviesData[currentCinema]) {
                moviesData[currentCinema] = [];
            }

            if (editingMovieId) {
                const index = moviesData[currentCinema].findIndex(m => m.id === editingMovieId);
                if (index !== -1) {
                    moviesData[currentCinema][index] = movie;
                    console.log('‚úÖ Updated movie at index:', index);
                }
            } else {
                moviesData[currentCinema].push(movie);
                console.log('‚úÖ Added new movie, total:', moviesData[currentCinema].length);
            }

            saveToHistory();
            saveToLocalStorage();
            resetForm();
            loadData();
            console.log('=== SAVE COMPLETE ===');
            
            const notification = document.getElementById('saveNotification');
            notification.classList.remove('hiding');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.classList.remove('show', 'hiding');
                }, 300);
            }, 2000);
        }

        function resetForm() {
            document.getElementById('movieTitle').value = '';
            document.getElementById('movieFormat').value = '';
            document.getElementById('movieLanguage').value = '';
            document.getElementById('sneakShow').checked = false;
            document.getElementById('posterInput').value = '';
            document.getElementById('posterPreview').style.display = 'none';
            
            // Reset all showtimes
            currentShowtimes = {};
            
            currentPosterData = null;
            editingMovieId = null;
            
            // Trigger sections update
            updateShowtimeSections();
        }

        function editMovie(id) {
            const movie = moviesData[currentCinema].find(m => m.id === id);
            if (!movie) return;

            console.log('=== EDIT MOVIE ===');
            console.log('Movie showtimes:', movie.showtimes);

            editingMovieId = id;
            document.getElementById('movieTitle').value = movie.title;
            document.getElementById('movieFormat').value = movie.format || '2D';
            document.getElementById('movieLanguage').value = movie.language || 'Ph·ª• ƒë·ªÅ';
            document.getElementById('sneakShow').checked = movie.sneakShow || false;
            document.getElementById('ageRating').value = movie.ageRating;
            
            currentPosterData = movie.poster;
            document.getElementById('posterPreview').src = currentPosterData;
            document.getElementById('posterPreview').style.display = 'block';

            // Load all showtimes from movie
            currentShowtimes = JSON.parse(JSON.stringify(movie.showtimes || {}));
            console.log('Loaded currentShowtimes:', currentShowtimes);
            
            // Trigger sections update based on format + language
            updateShowtimeSections();
            console.log('After updateShowtimeSections, currentShowtimes:', currentShowtimes);

            document.querySelector('.left-panel').scrollTop = 0;
        }

        function deleteMovie(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y?')) return;
            
            if (moviesData[currentCinema]) {
                moviesData[currentCinema] = moviesData[currentCinema].filter(m => m.id !== id);
            }
            saveToHistory();
            saveToLocalStorage();
            loadData();
        }

        function changeMovieOrder(movieId, newPosition, totalMovies) {
            newPosition = parseInt(newPosition);
            
            // Validate input
            if (isNaN(newPosition) || newPosition < 1 || newPosition > totalMovies) {
                alert(`Vui l√≤ng nh·∫≠p s·ªë t·ª´ 1 ƒë·∫øn ${totalMovies}`);
                loadData(); // Reload to reset input
                return;
            }
            
            const movies = moviesData[currentCinema];
            const currentIndex = movies.findIndex(m => m.id === movieId);
            
            if (currentIndex === -1) return;
            
            const newIndex = newPosition - 1;
            
            if (currentIndex === newIndex) return; // No change
            
            // Move movie to new position
            const [movedMovie] = movies.splice(currentIndex, 1);
            movies.splice(newIndex, 0, movedMovie);
            
            saveToHistory();
            saveToLocalStorage();
            loadData();
        }

        let draggedElement = null;
        let draggedIndex = null;

        function renderMoviesList(movies) {
            const container = document.getElementById('moviesList');
            const headerCounter = document.getElementById('headerMovieCount');
            
            // Update header counter - format "X phim" ho·∫∑c "X/X phim"
            if (movies.length === 0) {
                headerCounter.textContent = '0 phim';
            } else {
                headerCounter.textContent = `${movies.length} phim`;
            }
            
            // Determine cinema class for background color
            const cinemaClass = currentCinema === 'GALAXY VINH' ? 'cinema-vinh' : 'cinema-vincom';
            
            // Add cinema class to container
            container.className = `movies-list ${cinemaClass}`;
            
            if (movies.length === 0) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ phim n√†o ƒë∆∞·ª£c l∆∞u</div>';
                return;
            }

            container.innerHTML = '';
            movies.forEach((movie, index) => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.dataset.index = index;
                
                console.log('Rendering movie card:', movie.title);
                console.log('  movie.showtimes:', movie.showtimes);
                
                // Group showtimes by language then format
                const showtimesByLanguage = {};
                Object.keys(movie.showtimes || {}).forEach(sectionKey => {
                    if (movie.showtimes[sectionKey] && movie.showtimes[sectionKey].length > 0) {
                        // Parse section key (e.g., "2D Ph·ª• ƒë·ªÅ", "3D L·ªìng Ti·∫øng")
                        const times = movie.showtimes[sectionKey];
                        
                        let language = '';
                        let format = sectionKey;
                        
                        if (sectionKey.includes('Ph·ª• ƒë·ªÅ')) {
                            language = 'Ph·ª• ƒë·ªÅ';
                            format = sectionKey.replace(' Ph·ª• ƒë·ªÅ', '').replace('Ph·ª• ƒë·ªÅ', '').trim();
                        } else if (sectionKey.includes('L·ªìng Ti·∫øng')) {
                            language = 'L·ªìng Ti·∫øng';
                            format = sectionKey.replace(' L·ªìng Ti·∫øng', '').replace('L·ªìng Ti·∫øng', '').trim();
                        }
                        
                        // Skip if no language detected
                        if (!language) return;
                        
                        if (!showtimesByLanguage[language]) {
                            showtimesByLanguage[language] = {};
                        }
                        
                        if (!showtimesByLanguage[language][format]) {
                            showtimesByLanguage[language][format] = [];
                        }
                        
                        showtimesByLanguage[language][format].push(...times);
                    }
                });
                
                console.log('  showtimesByLanguage:', showtimesByLanguage);
                
                // Build HTML - format: Ng√¥n ng·ªØ Format: time
                let showtimesHTML = '';
                
                if (Object.keys(showtimesByLanguage).length === 0) {
                    showtimesHTML = '<span style="color: #ef4444; font-style: italic;">Ch∆∞a c√≥ gi·ªù chi·∫øu</span>';
                } else {
                    const languageGroups = [];
                    
                    Object.keys(showtimesByLanguage).forEach(language => {
                        const formats = showtimesByLanguage[language];
                        let groupHTML = '';
                        
                        // Get all format keys
                        const formatKeys = Object.keys(formats);
                        
                        formatKeys.forEach((format, idx) => {
                            const times = formats[format].sort();
                            
                            if (idx === 0) {
                                // First line: Ng√¥n ng·ªØ Format: time
                                groupHTML += `<div style="margin-bottom: 3px;">`;
                                groupHTML += `<span style="background: #fbbf24; color: #000; padding: 2px 6px; border-radius: 3px; font-weight: 600; margin-right: 4px;">${language}</span>`;
                                groupHTML += `<strong>${format}:</strong> ${times.join(', ')}`;
                                groupHTML += `</div>`;
                            } else {
                                // Subsequent lines: aligned under first format
                                const spacerWidth = 80; // Approximate width for language badge
                                groupHTML += `<div style="margin-bottom: 3px; padding-left: ${spacerWidth}px;">`;
                                groupHTML += `<strong>${format}:</strong> ${times.join(', ')}`;
                                groupHTML += `</div>`;
                            }
                        });
                        
                        languageGroups.push(groupHTML);
                    });
                    
                    showtimesHTML = languageGroups.join('<div style="margin: 6px 0;"></div>');
                }

                card.innerHTML = `
                    <div class="movie-card-header">
                        <div style="flex: 1;">
                            <h3><span class="age-badge age-${movie.ageRating}">${movie.ageRating}</span> ${movie.title}</h3>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" class="order-input" value="${index + 1}" min="1" max="${movies.length}" 
                                   onchange="changeMovieOrder(${movie.id}, this.value, ${movies.length})"
                                   onclick="event.stopPropagation()"
                                   title="Nh·∫≠p s·ªë th·ª© t·ª± ƒë·ªÉ s·∫Øp x·∫øp phim">
                            <span style="font-size: 13px; color: #9ca3af;">/${movies.length}</span>
                            <button class="btn-danger" onclick="event.stopPropagation(); deleteMovie(${movie.id})">X√≥a</button>
                        </div>
                    </div>
                    <div class="showtimes-list">
                        ${showtimesHTML}
                    </div>
                `;

                let dragTimer = null;
                let isDragging = false;

                // Double click to edit
                card.addEventListener('dblclick', function(e) {
                    if (!isDragging) {
                        editMovie(movie.id);
                    }
                });

                // Mousedown to start drag timer
                card.addEventListener('mousedown', function(e) {
                    if (e.target.closest('.btn-danger')) return;
                    
                    isDragging = false;
                    dragTimer = setTimeout(() => {
                        isDragging = true;
                        card.draggable = true;
                    }, 200); // 200ms hold to start drag
                });

                // Clear timer if mouse up before drag starts
                card.addEventListener('mouseup', function(e) {
                    clearTimeout(dragTimer);
                    if (!isDragging) {
                        card.draggable = false;
                    }
                });

                card.addEventListener('mouseleave', function(e) {
                    clearTimeout(dragTimer);
                });

                card.addEventListener('dragstart', function(e) {
                    if (!isDragging) {
                        e.preventDefault();
                        return;
                    }
                    draggedElement = card;
                    draggedIndex = parseInt(card.dataset.index);
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', function(e) {
                    card.classList.remove('dragging');
                    card.draggable = false;
                    isDragging = false;
                });

                card.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });

                card.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dropIndex = parseInt(card.dataset.index);
                    
                    if (draggedIndex !== dropIndex) {
                        const movedMovie = moviesData[currentCinema].splice(draggedIndex, 1)[0];
                        moviesData[currentCinema].splice(dropIndex, 0, movedMovie);
                        saveToHistory();
                        saveToLocalStorage();
                        loadData();
                    }
                });

                container.appendChild(card);
            });
        }

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        function generatePreview(movies) {
            const canvas = document.getElementById('scheduleCanvas');
            const ctx = canvas.getContext('2d');

            if (movies.length === 0) {
                canvas.width = 800;
                canvas.height = 200;
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Ch∆∞a c√≥ phim ƒë·ªÉ hi·ªÉn th·ªã', 400, 100);
                return;
            }

            const imagePromises = movies.map(movie => {
                return new Promise((resolve) => {
                    if (movie.poster) {
                        const img = new Image();
                        img.onload = () => resolve({ id: movie.id, img });
                        img.onerror = () => resolve({ id: movie.id, img: null });
                        img.src = movie.poster;
                    } else {
                        resolve({ id: movie.id, img: null });
                    }
                });
            });

            Promise.all(imagePromises).then(images => {
                const imageMap = {};
                images.forEach(({ id, img }) => {
                    imageMap[id] = img;
                });
                renderCanvas(movies, imageMap, ctx, canvas);
            });
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const testLine = currentLine + ' ' + words[i];
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function wrapShowtimes(ctx, times, startX, maxX, spacing) {
            const lines = [];
            let currentLine = [];
            let currentX = startX;

            times.forEach(time => {
                const timeWidth = ctx.measureText(time).width;
                
                if (currentX + timeWidth > maxX && currentLine.length > 0) {
                    lines.push(currentLine);
                    currentLine = [time];
                    currentX = startX + timeWidth + spacing;
                } else {
                    currentLine.push(time);
                    currentX += timeWidth + spacing;
                }
            });

            if (currentLine.length > 0) {
                lines.push(currentLine);
            }

            return lines;
        }

        function renderCanvas(movies, imageMap, ctx, canvas) {
            const cinemaConfig = CINEMA_CONFIG[currentCinema];
            
            const canvasWidth = 800;
            const headerHeight = 120;
            const footerHeight = 70; // Gi·∫£m t·ª´ 120 xu·ªëng 70
            const posterWidth = 135;
            const posterHeight = 190;
            const movieLeftMargin = 165;
            const titleLineHeight = 30;
            const showtimeLineHeight = 32;
            const showtimeSpacing = 25;
            const badgeToLineSpacing = 10; // Gi·∫£m t·ª´ 20 xu·ªëng 10

            // Calculate heights for each movie
            const movieHeights = movies.map(movie => {
                ctx.font = 'bold 22px Arial';
                
                let fullTitle = movie.title;
                // Ch·ªâ th√™m Sneak Show v√†o title
                if (movie.sneakShow) {
                    fullTitle += ' (Sneak Show)';
                }
                
                const maxTextWidth = canvasWidth - movieLeftMargin - 30;
                const titleLines = wrapText(ctx, fullTitle, maxTextWidth);
                const titleHeight = titleLines.length * titleLineHeight + 10;
                
                // Calculate showtimes height for all format combinations
                let showtimesHeight = 0;
                ctx.font = 'bold 20px Arial';
                
                const showtimeKeys = Object.keys(movie.showtimes).filter(key => 
                    movie.showtimes[key] && movie.showtimes[key].length > 0
                );
                
                if (showtimeKeys.length === 1) {
                    const times = movie.showtimes[showtimeKeys[0]];
                    const lines = wrapShowtimes(ctx, times, movieLeftMargin, 780, showtimeSpacing);
                    showtimesHeight = lines.length * showtimeLineHeight;
                } else if (showtimeKeys.length > 1) {
                    // Find max label width (kh√¥ng t√≠nh d·∫•u :)
                    ctx.font = 'bold 18px Arial';
                    let maxLabelWidth = 0;
                    showtimeKeys.forEach(key => {
                        const w = ctx.measureText(key).width;
                        if (w > maxLabelWidth) maxLabelWidth = w;
                    });
                    
                    const colonX = movieLeftMargin + maxLabelWidth + 5;
                    const showtimeStartX = colonX + ctx.measureText(':').width + 10;
                    
                    showtimeKeys.forEach(key => {
                        ctx.font = 'bold 20px Arial';
                        const times = movie.showtimes[key];
                        const lines = wrapShowtimes(ctx, times, showtimeStartX, 780, showtimeSpacing);
                        showtimesHeight += lines.length * showtimeLineHeight + 5;
                    });
                }
                
                const totalTextHeight = titleHeight + showtimesHeight;
                const contentHeight = Math.max(posterHeight, totalTextHeight);
                
                // Badge ƒë·∫øn line = 20px
                return contentHeight + badgeToLineSpacing;
            });

            const totalMoviesHeight = movieHeights.reduce((sum, h) => sum + h, 0) + (movies.length - 1) * 25; // Gi·∫£m t·ª´ 40 xu·ªëng 25
            const canvasHeight = headerHeight + totalMoviesHeight + footerHeight + 20; // Gi·∫£m buffer t·ª´ 40 xu·ªëng 20

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            ctx.fillStyle = cinemaConfig.backgroundColor;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Draw header with LED frame
            const headerBoxX = 155;
            const headerBoxY = 15;
            const headerBoxW = 490;
            const headerBoxH = 75;
            const headerRadius = 12;
            
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(headerBoxX + headerRadius, headerBoxY);
            ctx.lineTo(headerBoxX + headerBoxW - headerRadius, headerBoxY);
            ctx.arcTo(headerBoxX + headerBoxW, headerBoxY, headerBoxX + headerBoxW, headerBoxY + headerRadius, headerRadius);
            ctx.lineTo(headerBoxX + headerBoxW, headerBoxY + headerBoxH - headerRadius);
            ctx.arcTo(headerBoxX + headerBoxW, headerBoxY + headerBoxH, headerBoxX + headerBoxW - headerRadius, headerBoxY + headerBoxH, headerRadius);
            ctx.lineTo(headerBoxX + headerRadius, headerBoxY + headerBoxH);
            ctx.arcTo(headerBoxX, headerBoxY + headerBoxH, headerBoxX, headerBoxY + headerBoxH - headerRadius, headerRadius);
            ctx.lineTo(headerBoxX, headerBoxY + headerRadius);
            ctx.arcTo(headerBoxX, headerBoxY, headerBoxX + headerRadius, headerBoxY, headerRadius);
            ctx.closePath();
            ctx.stroke();
            
            const innerPadding = 8;
            const innerBoxX = headerBoxX + innerPadding;
            const innerBoxY = headerBoxY + innerPadding;
            const innerBoxW = headerBoxW - 2 * innerPadding;
            const innerBoxH = headerBoxH - 2 * innerPadding;
            
            ctx.fillStyle = '#e8dcc8';
            ctx.beginPath();
            ctx.moveTo(innerBoxX + headerRadius, innerBoxY);
            ctx.lineTo(innerBoxX + innerBoxW - headerRadius, innerBoxY);
            ctx.arcTo(innerBoxX + innerBoxW, innerBoxY, innerBoxX + innerBoxW, innerBoxY + headerRadius, headerRadius);
            ctx.lineTo(innerBoxX + innerBoxW, innerBoxY + innerBoxH - headerRadius);
            ctx.arcTo(innerBoxX + innerBoxW, innerBoxY + innerBoxH, innerBoxX + innerBoxW - headerRadius, innerBoxY + innerBoxH, headerRadius);
            ctx.lineTo(innerBoxX + headerRadius, innerBoxY + innerBoxH);
            ctx.arcTo(innerBoxX, innerBoxY + innerBoxH, innerBoxX, innerBoxY + innerBoxH - headerRadius, headerRadius);
            ctx.lineTo(innerBoxX, innerBoxY + headerRadius);
            ctx.arcTo(innerBoxX, innerBoxY, innerBoxX + headerRadius, innerBoxY, headerRadius);
            ctx.closePath();
            ctx.fill();
            
            // LED dots
            const dotRadius = 3;
            const dotMargin = headerBoxY + innerPadding / 2;
            const dotCountTop = 42;
            const dotSpacingTop = (headerBoxW - 20) / (dotCountTop - 1);
            ctx.fillStyle = '#ffffff';
            
            for (let i = 0; i < dotCountTop; i++) {
                const dotX = headerBoxX + 10 + i * dotSpacingTop;
                ctx.beginPath();
                ctx.arc(dotX, dotMargin, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            const dotMarginBottom = headerBoxY + headerBoxH - innerPadding / 2;
            for (let i = 0; i < dotCountTop; i++) {
                const dotX = headerBoxX + 10 + i * dotSpacingTop;
                ctx.beginPath();
                ctx.arc(dotX, dotMarginBottom, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            const dotCountSide = Math.floor(headerBoxH / (headerBoxW / dotCountTop));
            const dotSpacingSide = (headerBoxH - 20) / (dotCountSide - 1);
            
            for (let i = 0; i < dotCountSide; i++) {
                const dotY = headerBoxY + 10 + i * dotSpacingSide;
                ctx.beginPath();
                ctx.arc(headerBoxX + innerPadding / 2, dotY, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            for (let i = 0; i < dotCountSide; i++) {
                const dotY = headerBoxY + 10 + i * dotSpacingSide;
                ctx.beginPath();
                ctx.arc(headerBoxX + headerBoxW - innerPadding / 2, dotY, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = '#1e40af';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(cinemaConfig.name, 400, 42);
            
            const date = selectedDate ? formatDate(selectedDate) : '01/01/2026';
            ctx.font = 'bold 16px Arial';
            
            const textParts = [
                { text: 'L·ªãch ', color: '#1e40af' },
                { text: 'D·ª∞ KI·∫æN', color: '#dc2626' },
                { text: ` ng√†y ${date}`, color: '#1e40af' }
            ];
            
            let xPos = 400;
            const totalWidth = textParts.reduce((sum, part) => {
                ctx.font = 'bold 16px Arial';
                return sum + ctx.measureText(part.text).width;
            }, 0);
            
            xPos = 400 - totalWidth / 2;
            textParts.forEach(part => {
                ctx.fillStyle = part.color;
                ctx.textAlign = 'left';
                ctx.fillText(part.text, xPos, 67);
                xPos += ctx.measureText(part.text).width;
            });

            let yPos = headerHeight + 20;

            const ageColors = {
                'P': '#10b981',
                'K': '#f59e0b',
                'T13': '#ef4444',
                'T16': '#dc2626',
                'T18': '#991b1b'
            };

            movies.forEach((movie, index) => {
                const movieStartY = yPos;
                
                // Draw poster
                const img = imageMap[movie.id];
                const posterX = 10;
                const posterY = yPos;

                if (img) {
                    ctx.drawImage(img, posterX, posterY, posterWidth, posterHeight);
                } else {
                    ctx.fillStyle = '#d1d5db';
                    ctx.fillRect(posterX, posterY, posterWidth, posterHeight);
                }

                // Age rating badge at TOP RIGHT CORNER of poster
                const badgeX = posterX + posterWidth;
                const badgeY = posterY;
                const badgeRadius = 20;
                
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(badgeX, badgeY, badgeRadius + 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = ageColors[movie.ageRating];
                ctx.beginPath();
                ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(movie.ageRating, badgeX, badgeY + 5);
                
                // Draw title
                ctx.font = 'bold 22px Arial';
                ctx.textAlign = 'left';
                
                let fullTitle = movie.title;
                // Ch·ªâ th√™m Sneak Show v√†o title
                if (movie.sneakShow) {
                    fullTitle += ' (Sneak Show)';
                }
                
                const maxTextWidth = canvasWidth - movieLeftMargin - 30;
                const titleLines = wrapText(ctx, fullTitle, maxTextWidth);
                
                let textY = posterY + 25;
                
                titleLines.forEach((line, lineIndex) => {
                    const parenIndex = line.indexOf('(');
                    if (parenIndex !== -1 && movie.sneakShow) {
                        const beforeParen = line.substring(0, parenIndex);
                        const afterParen = line.substring(parenIndex);
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(beforeParen, movieLeftMargin, textY);
                        
                        const beforeWidth = ctx.measureText(beforeParen).width;
                        ctx.fillStyle = '#fbbf24';
                        ctx.fillText(afterParen, movieLeftMargin + beforeWidth, textY);
                    } else {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(line, movieLeftMargin, textY);
                    }
                    textY += titleLineHeight;
                });
                
                textY += 10;
                
                // Draw showtimes - group by language
                const showtimesByLanguage = {};
                Object.keys(movie.showtimes).forEach(sectionKey => {
                    if (movie.showtimes[sectionKey] && movie.showtimes[sectionKey].length > 0) {
                        const times = movie.showtimes[sectionKey];
                        
                        let language = '';
                        let format = sectionKey;
                        
                        if (sectionKey.includes('Ph·ª• ƒë·ªÅ')) {
                            language = 'Ph·ª• ƒë·ªÅ';
                            format = sectionKey.replace(' Ph·ª• ƒë·ªÅ', '').replace('Ph·ª• ƒë·ªÅ', '').trim();
                        } else if (sectionKey.includes('L·ªìng Ti·∫øng')) {
                            language = 'L·ªìng Ti·∫øng';
                            format = sectionKey.replace(' L·ªìng Ti·∫øng', '').replace('L·ªìng Ti·∫øng', '').trim();
                        }
                        
                        if (!language) return;
                        
                        if (!showtimesByLanguage[language]) {
                            showtimesByLanguage[language] = {};
                        }
                        
                        if (!showtimesByLanguage[language][format]) {
                            showtimesByLanguage[language][format] = [];
                        }
                        
                        showtimesByLanguage[language][format].push(...times);
                    }
                });
                
                ctx.fillStyle = '#ffffff';
                
                // Calculate max language width for alignment
                ctx.font = 'bold 16px Arial';
                const maxLangWidth = Math.max(
                    ctx.measureText('Ph·ª• ƒë·ªÅ ').width,
                    ctx.measureText('L·ªìng Ti·∫øng ').width
                );
                
                // Render each language group
                Object.keys(showtimesByLanguage).forEach(language => {
                    const formats = showtimesByLanguage[language];
                    const formatKeys = Object.keys(formats);
                    
                    formatKeys.forEach((format, idx) => {
                        const times = formats[format].sort();
                        
                        if (idx === 0) {
                            // First line: Ng√¥n ng·ªØ Format: time
                            // Draw language badge with fixed width
                            ctx.fillStyle = '#fbbf24';
                            ctx.font = 'bold 16px Arial';
                            ctx.fillText(language, movieLeftMargin, textY);
                            
                            // Draw format + colon at fixed position
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 18px Arial';
                            const formatText = format + ': ';
                            const formatX = movieLeftMargin + maxLangWidth;
                            ctx.fillText(formatText, formatX, textY);
                            
                            // Draw times
                            ctx.font = 'bold 20px Arial';
                            let stX = formatX + ctx.measureText(formatText).width;
                            times.forEach((time, timeIdx) => {
                                ctx.fillText(time, stX, textY);
                                stX += ctx.measureText(time).width + (timeIdx < times.length - 1 ? 25 : 0);
                            });
                            
                        } else {
                            // Subsequent lines: align format at same position
                            textY += showtimeLineHeight;
                            
                            // Draw format + colon at fixed position (aligned with first line)
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 18px Arial';
                            const formatText = format + ': ';
                            const formatX = movieLeftMargin + maxLangWidth;
                            ctx.fillText(formatText, formatX, textY);
                            
                            // Draw times
                            ctx.font = 'bold 20px Arial';
                            let stX = formatX + ctx.measureText(formatText).width;
                            times.forEach((time, timeIdx) => {
                                ctx.fillText(time, stX, textY);
                                stX += ctx.measureText(time).width + (timeIdx < times.length - 1 ? 25 : 0);
                            });
                        }
                    });
                    
                    textY += showtimeLineHeight + 5; // Space between language groups
                });
                
                // Calculate line position - badge ƒë·∫øn line = 20px
                const contentHeight = Math.max(posterHeight, textY - posterY);
                const lineY = movieStartY + contentHeight + badgeToLineSpacing;
                
                // Update yPos for next movie
                yPos = lineY;
                
                // Draw divider line if not last movie
                if (index < movies.length - 1) {
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(20, lineY);
                    ctx.lineTo(780, lineY);
                    ctx.stroke();
                    
                    yPos += 25; // Gi·∫£m t·ª´ 40 xu·ªëng 25
                }
            });

            // Footer
            yPos += 15; // Gi·∫£m t·ª´ 25 xu·ªëng 15
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`C·∫≠p nh·∫≠t l·ªãch chi·∫øu ${currentCinema} CH√çNH X√ÅC NH·∫§T t·∫°i`, 400, yPos);
            
            yPos += 20;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(cinemaConfig.url, 400, yPos);
        }

        // Store last used directory handles in IndexedDB (persistent across sessions)
        let lastPNGFolderHandle = null;
        let lastJSONFolderHandle = null;
        
        // IndexedDB helper functions
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GalaxyCinemaDB', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('folders')) {
                        db.createObjectStore('folders');
                    }
                };
            });
        }
        
        async function saveFolderHandle(key, handle) {
            try {
                const db = await openDB();
                const tx = db.transaction('folders', 'readwrite');
                const store = tx.objectStore('folders');
                store.put(handle, key);
                await tx.complete;
                console.log('‚úÖ ƒê√£ l∆∞u folder handle:', key);
            } catch (e) {
                console.error('‚ùå L·ªói l∆∞u folder handle:', e);
            }
        }
        
        async function loadFolderHandle(key) {
            try {
                const db = await openDB();
                const tx = db.transaction('folders', 'readonly');
                const store = tx.objectStore('folders');
                return new Promise((resolve, reject) => {
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('‚ùå L·ªói load folder handle:', e);
                return null;
            }
        }
        
        // Load saved folder handles on startup
        (async function() {
            lastPNGFolderHandle = await loadFolderHandle('pngFolder');
            lastJSONFolderHandle = await loadFolderHandle('jsonFolder');
            if (lastPNGFolderHandle) console.log('‚úÖ ƒê√£ load PNG folder handle');
            if (lastJSONFolderHandle) console.log('‚úÖ ƒê√£ load JSON folder handle');
        })();

        async function downloadSchedule() {
            const canvas = document.getElementById('scheduleCanvas');
            const imageData = canvas.toDataURL('image/png'); // Full quality PNG
            
            // Format: dd-mm-yyyy TenRap.png
            const [year, month, day] = selectedDate.split('-');
            const dateStr = `${day}-${month}-${year}`;
            const cinemaName = currentCinema.replace(/GALAXY |CINE\+ /g, '').trim();
            const fileName = `${dateStr} ${cinemaName}.png`;
            
            // Try File System Access API first (for choosing folder)
            if ('showSaveFilePicker' in window) {
                try {
                    const options = {
                        suggestedName: fileName,
                        types: [{
                            description: 'PNG Images',
                            accept: {'image/png': ['.png']}
                        }]
                    };
                    
                    // Use saved PNG folder if available
                    if (lastPNGFolderHandle) {
                        try {
                            // Verify we still have permission
                            const permission = await lastPNGFolderHandle.queryPermission({ mode: 'readwrite' });
                            if (permission === 'granted') {
                                options.startIn = lastPNGFolderHandle;
                                console.log('üìÇ S·ª≠ d·ª•ng folder ƒë√£ l∆∞u');
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ d√πng folder c≈©:', e);
                        }
                    }
                    
                    const handle = await window.showSaveFilePicker(options);
                    
                    // Save parent folder for next time
                    try {
                        const parent = await handle.getParent();
                        lastPNGFolderHandle = parent;
                        await saveFolderHandle('pngFolder', parent);
                        console.log('‚úÖ ƒê√£ l∆∞u PNG folder');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u folder:', e);
                    }
                    
                    const blob = await (await fetch(imageData)).blob();
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    // Save movie data to localStorage after successful download
                    saveMovieDataOnDownload();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Save failed:', err);
                    }
                }
            } else {
                // Fallback to traditional download
                const link = document.createElement('a');
                link.download = fileName;
                link.href = imageData;
                link.click();
                
                // Save movie data to localStorage
                saveMovieDataOnDownload();
            }
        }
        
        function saveMovieDataOnDownload() {
            try {
                // Save COMPLETE state in ONE object
                const completeState = {
                    selectedDate: selectedDate,
                    moviesData: JSON.parse(JSON.stringify(moviesData)),
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('galaxyCinema_completeState', JSON.stringify(completeState));
                console.log('‚úÖ Saved complete state:', completeState);
                
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // Clear old data and retry
                    localStorage.removeItem('galaxyCinema_savedDates');
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('galaxyCinema_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    const completeState = {
                        selectedDate: selectedDate,
                        moviesData: JSON.parse(JSON.stringify(moviesData)),
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('galaxyCinema_completeState', JSON.stringify(completeState));
                    console.log('‚úÖ Saved after cleanup');
                } else {
                    console.error('‚ùå Save error:', e);
                }
            }
        }
        
        
        function showNotification(message, type = 'success') {
            const colors = {
                success: '#10b981',
                info: '#3b82f6',
                warning: '#f59e0b',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        document.getElementById('cinemaSelect').addEventListener('change', loadData);

        console.log('üîÑ ƒêang t·∫£i d·ªØ li·ªáu...');
        loadFromLocalStorage();
        console.log('üìä moviesData sau khi load:', moviesData);
        loadData();
        console.log('‚úÖ Kh·ªüi t·∫°o ho√†n t·∫•t');
        
        // Toggle data menu
        function toggleDataMenu() {
            const dropdown = document.getElementById('dataMenuDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const wrapper = e.target.closest('.menu-wrapper');
            const dropdown = document.getElementById('dataMenuDropdown');
            
            if (!wrapper && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // Auto clean movie title when pasting (remove Galaxy appended text)
        document.getElementById('movieTitle').addEventListener('paste', function (e) {
            e.preventDefault();

            let text = (e.clipboardData || window.clipboardData).getData('text');

            // Only keep first line
            text = text.split('\n')[0];

            // Remove Galaxy appended text
            text = text.replace(/Xem th√™m t·∫°i:.*/i, '').trim();

            this.value = text;
        });

    </script>
</body>
</html>
